name: ğŸš€ Deploy AnÃ¡lise de CrÃ©dito para Azure

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: ğŸ§ª Testes Automatizados
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: ğŸ“¦ Cache dependÃªncias
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: âš™ï¸ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8
    
    - name: ğŸ” Lint com flake8
      run: |
        # Para por se houver erros de sintaxe ou nomes indefinidos
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Avisos tratados como avisos
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: ğŸ¤– Treinar modelo mock
      run: |
        python model_mock.py
    
    - name: ğŸ§ª Executar testes
      run: |
        python -m pytest tests/ -v --tb=short
    
    - name: ğŸ”Œ Testar API
      run: |
        python test_prediction.py

  build-and-deploy:
    name: ğŸ³ Build e Deploy
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ” Login Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ğŸ³ Login Docker Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
    
    - name: ğŸ—ï¸ Build e Push Docker Image
      run: |
        docker build -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/analise-credito:${{ github.sha }} .
        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/analise-credito:${{ github.sha }}
        docker tag ${{ secrets.REGISTRY_LOGIN_SERVER }}/analise-credito:${{ github.sha }} ${{ secrets.REGISTRY_LOGIN_SERVER }}/analise-credito:latest
        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/analise-credito:latest
    
    - name: ğŸš€ Deploy para Azure Container Instances
      uses: azure/aci-deploy@v1
      with:
        resource-group: ${{ secrets.RESOURCE_GROUP }}
        dns-name-label: analise-credito-${{ github.run_number }}
        image: ${{ secrets.REGISTRY_LOGIN_SERVER }}/analise-credito:latest
        registry-login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
        registry-username: ${{ secrets.REGISTRY_USERNAME }}
        registry-password: ${{ secrets.REGISTRY_PASSWORD }}
        name: analise-credito-container
        ports: '5000 8501'
        cpu: 2
        memory: 4
    
    - name: âœ… Deploy concluÃ­do
      run: |
        echo "ğŸ‰ Deploy realizado com sucesso!"
        echo "ğŸ¦ AplicaÃ§Ã£o: http://analise-credito-${{ github.run_number }}.brazilsouth.azurecontainer.io:8501"
        echo "ğŸ”Œ API: http://analise-credito-${{ github.run_number }}.brazilsouth.azurecontainer.io:5000/health"

  security-scan:
    name: ğŸ”’ VerificaÃ§Ã£o de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: ğŸ” Scan de seguranÃ§a com bandit
      run: |
        pip install bandit
        bandit -r . -f json -o security-report.json || true
    
    - name: ğŸ“Š Upload relatÃ³rio de seguranÃ§a
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security-report.json

  performance-test:
    name: ğŸš€ Teste de Performance
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: âš™ï¸ Instalar dependÃªncias
      run: |
        pip install -r requirements.txt
        pip install locust
    
    - name: ğŸ¤– Preparar ambiente
      run: |
        python model_mock.py
        python api_mock.py &
        sleep 10
    
    - name: ğŸƒ Teste de carga
      run: |
        locust --headless --users 10 --spawn-rate 2 --run-time 60s --host http://localhost:5000 -f tests/locustfile.py || true
